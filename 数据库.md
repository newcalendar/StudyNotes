# 数据库

数据库是按照数据结构来组织、管理、存储的仓库，是一种存储在计算机内的有结构的数据集合。另外除了数据库，还有相应的数据库管理系统，它介于用户与操作系统之间的数据管理工具。

## 关系型数据库

关系型数据库是数据库的一种类别，指的是采用了一定的关系模型来组织数据，以行列表的形式来存储数据

### MySQL

mysql数据库也是关系型数据库的一种，大部分的关系型数据库都使用SQL（结构化查询语言）来操作数据库，MySQL是开源成熟的关系型数据库

#### MySQL基本结构

MySQL主要分为Server层和存储引擎层

Server层主要包括连接器、分析器、优化器、执行器等，存储引擎主要是InnoDB\MyISAM等，主要使用的是InnoDB数据库引擎

整个执行流程是权限校验->分析器->优化器->权限校验->执行器->引擎

#### 存储引擎

InnoDB是当前MYSQL的存储引擎，支持行级锁，并提供了事务支持，具备提交、回滚事务的能力，具备外键的能力，支持数据库异常崩溃后的安全恢复，支持MVCC

大部分情况下选择InnoDB

#### 锁机制

表级锁，锁定粒度最大的一种锁，对当前操作的整张表加锁，实现简单，消耗较低

其中分为写锁和读锁，读锁表示所有会话只能进行读操作，写锁，表示只有获取锁的事项才能进行写操作

行级锁，锁粒度最小的一种锁，只针对当前操作的行进行加锁‘

悲观锁和乐观锁

悲观锁：总设想每次都是最坏的情况，每次读取数据都认为别人会修改，所以每次都在拿数据时上锁。

乐观锁：总设想每次都是好情况，每次拿数据都认为别人不会修改，但是在更新的时候回判断期间有没有更新此数据

一般而言乐观锁用多读场景，悲观锁用于多写

#### 事务

事务是逻辑上一组操作，要么全部执行要么全都不执行，事务一般都具有原子性、一致性、隔离性、持久性

原子性：事务最小的执行单位，不能分割，即要保证全部完成，要么不执行

一致性：事务执行的前后，数据保持一致

隔离性：并发访问数据库时，一个用户的事务不被其它事务所干扰，各并发事务之间数据库时独立

持久性：一个事务被提交后。它对数据库中数据的改变是持久的，即使数据库发生故障也不应该对其有任何影响

#### 事务可能出现的问题

脏读：当一个事务正在操作数据库时，还未提交，另一个事务也访问该数据，此时就会造成脏读

不可重复读，指的是一个事务内多次读同一个数据，在这个事务没有结束是，另一个事务也访问该数据

幼读：当一个事务读取了几行数据，另一个数据插入数据。在同样的条件下查询，第一个事务会得到不一样的结果

##### 事务隔离级别

读取未提交：允许读取尚未提交的数据，可能造成脏读、幼读或者是不可重复读

读取已提交：允许读取并发事务已经提交的数据，可以阻止脏读，但是幻读、幼读、或不可重复读。

可重复读：对同一个字段的多次读取结果都一致，除非数据被本身修改，可以阻止脏读、不可重复读

可串行化：最高的隔离级别，可以防止脏读、不可重复读和幻读

#### 索引

MySQL索引主要使用两种数据结构，一个是哈希索引、BTree索引

#### 覆盖索引介绍

概念：索引覆盖所有需要查询的字段值，我们就称之为覆盖所有。

如果没有索引，遍历数据只能从头到尾进行遍历，但是索引可以使查询数据变得快速

索引优缺点：

优点是使用索引能加大数据检索的速度，另外唯一索引能保证数据库的数据唯一性

缺点：创建索引需要消耗资源，维护索引需要耗费许多时间，如果不合理的设置索引，反而会影响数据库的存储速度，和SQL的执行效率

索引的底层一般是Hash表和B+树

#### 索引类型

主键索引，一个表只能有一个主键，不能为NULL，不能重复

唯一索引，该数据不能会NULL而且不能重复

普通索引的唯一作用就是快速查询数据

全文索引，全文索引主要是为了检索大文本数据中的关键信息

前缀索引，前缀索引只适用于字符串类型的数据。前缀索引对文本的前几个字符创建索引，相比普通索引，建立的数据更小

另一个种分类：

聚集索引和非聚集索引，聚集索引即索引结构和数据一起存放，而非聚集索引则相反。主键索引数据聚集索引，而二级索引即普通索引、唯一索引等为非聚集索引，索引结构不与数据一起存放。

添加索引命令：

1.添加 PRIMARY KEY（主键索引）

```sql
ALTER TABLE `table_name` ADD PRIMARY KEY ( `column` )
```

2.添加 UNIQUE(唯一索引)

```sqlite
ALTER TABLE `table_name` ADD UNIQUE ( `column` )
```

3.添加 INDEX(普通索引)

```sql
ALTER TABLE `table_name` ADD INDEX index_name ( `column` )
```

4.添加 FULLTEXT(全文索引)

```sql
ALTER TABLE `table_name` ADD FULLTEXT ( `column`)
```

5.添加多列索引

```sql
ALTER TABLE `table_name` ADD INDEX index_name ( `column1`, `column2`, `column3` )
```

#### 数据库高性能优化

##### 数据库命名规范

所有数据库对象名称必须使用小写字母并用下划线分割，数据库名要做到见名知意

##### 数据设计规范

数据一般情况下选择InnoDB和UTF-8，所有表和字段都要命名容易知人意，并且加上注释，尽量控制单表数据量大小在500万以内

#### 数据库操作

##### 一、基本操作

启动mysql

```
net start mysql
```



```
-- 查看当前数据库
SELECT DATABASE();
-- 显示当前时间、用户名和数据库的版本
SELECT now(),usr(),version();
--创建库
CREATE DATABASE
```

